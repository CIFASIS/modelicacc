# Target variables
MODE ?= Debug

# The Directories, Source, Includes, Objects, Binary 
ROOT   	        := ..
3RD_PARTY_DIR   := ./3rd-party
GTEST_DIR       := googletest-release-1.10.0
GTEST_CODE      := $(GTEST_DIR).tar.gz

# Flags, Libraries and Includes
CXXFLAGS = -std=c++14 -I. -Wall -Werror -Wno-reorder -O3 
ifeq ($(MODE),Debug)
CXXFLAGS 	+= -ggdb  
endif
DEPDIR := .
DEPFLAGS = -MT $@ -MMD -MP -MF $(DEPDIR)/$*.Td
LIBMODELICA = lib/libmodelica.a
COMPILE.cc = $(CXX) $(DEPFLAGS) $(CXXFLAGS) $(CPPFLAGS) $(TARGET_ARCH) -c
POSTCOMPILE = mv -f $(DEPDIR)/$*.Td $(DEPDIR)/$*.d

SRC_COMMON := \
    ast/expression.cpp \
		ast/class.cpp \
		ast/equation.cpp \
		ast/statement.cpp \
		ast/modification.cpp \
		ast/element.cpp \
		ast/expression.cpp \
		parser/ident.cpp \
		parser/expression.cpp \
		parser/modification.cpp \
		parser/equation.cpp \
		parser/statement.cpp \
		parser/class.cpp \
		parser/parser.cpp \

all: lib-gtest $(LIBMODELICA)


include antialias/Makefile.include
include mmo/Makefile.include
include flatter/Makefile.include
include causalize/Makefile.include
include test/causalize/Makefile.include
include test/util/Makefile.include

OBJS_COMMON = $(SRC_COMMON:.cpp=.o)

%.o : %.cpp %.d
	$(COMPILE.cc) $(OUTPUT_OPTION) $<
	$(POSTCOMPILE)

$(LIBMODELICA): $(OBJS_COMMON)
	$(AR) rcs $(LIBMODELICA) $(OBJS_COMMON)

-include $(patsubst %,$(DEPDIR)/%.d,$(basename $(SRC_COMMON)))

$(DEPDIR)/%.d: ;
.PRECIOUS: $(DEPDIR)/%.d

doc: Doxyfile
	doxygen

lib-gtest: | create-dirs 
ifeq ("$(wildcard $(3RD_PARTY_DIR)/gtest/usr/lib)","")
	cd $(3RD_PARTY_DIR)/gtest; tar xvzf $(GTEST_CODE)
	mkdir -p $(3RD_PARTY_DIR)/gtest/build
	cd $(3RD_PARTY_DIR)/gtest/build; cmake ../$(GTEST_DIR) -DCMAKE_INSTALL_PREFIX=$(ROOT)/usr  
	cd $(3RD_PARTY_DIR)/gtest/build; make install 
	rm -rf $(3RD_PARTY_DIR)/gtest/$(GTEST_DIR)
	rm -rf $(3RD_PARTY_DIR)/gtest/build
endif

create-dirs:
	@mkdir -p $(ROOT)/lib

clean:
	$(RM) -rf $(OBJS_COMMON) $(OBJS_ANTIALIAS) $(OBJS_FLATTER) $(OBJS_MMO) $(OBJS_CAUSALIZE) $(LIBMODELICA) doc; \
	find . -name "*.d" -delete

help:
	@echo "make MODE=<Debug|Release> "
	@echo "Default values:"
	@echo ""
	@echo "MODE=Debug"
